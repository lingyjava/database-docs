# 3·Redis持久化

- [3·Redis持久化](#3redis持久化)
  - [RDB（Redis DataBase）](#rdbredis-database)
  - [AOF（Append Only File）](#aofappend-only-file)

## RDB（Redis DataBase）
在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是Snapshot快照。它恢复时是将快照文件直接读到内存里，Redis会单独创建一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束，再用这个临时文件替换上次持久化的文件。
整个过程中主进程不进行任何IO操作，确保了极高的性能，如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是十分敏感，那么RDB方式比AOF方式更加高效。RDB的缺点是最后一次持久化的数据可能丢失。

1. 通过配置满足条件时快照可以自动触发，并产生dump.rdb文件，也可以通过save命令手动触发快照，在save时阻塞其他操作，bgsave会在后台异步进行快照操作，快照同时还可以响应客户端请求。通过lastsave命令获取最后一次成功执行快照的时间。
2. 执行flushall命令，也会产生dump.rdb文件，但是空文件，无意义。
3. 将备份文件dump.rdb移动到redis安装目录并启动服务可以自动把硬盘中的数据导入内存中。
4. 配置文件如下：
![图5-Redis-RDB配置](/docs/images/图5-Redis-RDB配置.png)

优点：适合大规模的数据恢复，对数据完整性和一致性要求不高。
缺点：在一定间隔时间做一次备份，所以如果redis意外dowm，就会丢失最后一次快照后的所有修改，fork时，内存中的数据被克隆了一份，大致两倍的膨胀性需要考虑。

## AOF（Append Only File）
以日志的形式来记录每个写操作，将执行Redis执行过的所有写指令记录下来（读操作不记录），只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数据，也就是，redis重启时会根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。
AOP采用文件追加方式，文件会越来越大，为避免出现这种情况，新增了重写机制，当AOF文件的大小超过所设定的阈值时，Redis就会启动AOF文件的内容压缩，只保留可以恢复数据的最小指令集。
可以使用命令bgrewr iteaof，AOF文件持续增长而过大时，会fork出一条新进程来将文件重写（也是先写临时文件最后在rename），遍历新进程的内存中数据，每条记录有一条的Set语句。重写AOF文件的操作，并没有读取旧的AOF文件，而是将整个内存中的数据库内容用命令的方式重写了一个新的AOF文件，这和快照类似。

1. AOF默认关闭，需要在配置文件中打开。修改默认的appendonly no，改为yes。
2. AOF产生的文件名默认：appendonly.aof
3. 取值有三个级别
   - always：每次修改同步。
   - everysec：每秒同步，默认。
   - no：不同步。
4. 如果rdb和aof文件共存时先加载aof文件，由于如果aof文件损坏导致redis无法启动：进行redis安装目录：输入`redis-check-aof --fix appendonly.aof`修复。

优点：同步持久化每次发生数据变更被立即记录到磁盘，性能较差，但完整性较好。
缺点：aof运行效率慢于rdb，每秒同步策略效率较好，不同步效率和rdb相同。
